{% extends "base.html" %}
{% block content %}
<p class="title selectable" style="margin: auto;margin-bottom: 10px;">Feedback</p>
<div class="container floater" style="text-align: center;">
	<!-- Create feedback -->
	<div style="display: flex; width:100%; margin-bottom: 10px;">
		<figure class="image is-48x48" style="width:40px;height: 40px; float: left; margin-right: 5px;">
				<img class="is-rounded" src="{{current_user.profile_photo.src}}">
			</figure>
		<div class="field is-expanded has-addons" style="float:right; width: 100%;">
                  <p class="control has-icons-left" style="width: 100%;">
                    <input id="create-feedback" class="input" type="location" placeholder='Create feedback'>
                    <span class="icon is-small is-left">
	                    	<i class="fa fa-pencil"></i>
	                  	</span>
                  </p>
      </div>
  </div>

    <!-- Filter feedback -->
    <div class="is-centered" style="background-color: #ffff; border-radius: 10px; clear: both; padding: 5px; margin: auto;">
    <div class="field is-expanded has-addons" style="float:left; margin-right: 10px;">
    			<p class="control has-icons-left">
                    <input id="search-feedback" class="input" type="location" placeholder='Search feedback'>
                    <span class="icon is-small is-left">
	                    	<i class="fa fa-search"></i>
	                  	</span>
           </p>
       </div>
    <div class="field is-grouped">
    	<p class="control">
    <button class="button transition fb-search-b" data-on="is-danger is-light" data-active="false">
      <span id="cog" class="icon">
        <i class="fas fa-fire-alt"></i>
      </span>
    </button>
  </p>
  <p class="control">
    <button class="button transition fb-search-b" data-on="is-warning is-light" data-active="false">
      <span id="cog" class="icon">
        <i class="fas fa-medal"></i>
      </span>
    </button>
  </p>
  <p class="control">
    <button class="button transition fb-search-b" data-on="is-success is-light" data-active="false">
      <span id="cog" class="icon">
        <i class="fas fa-seedling"></i>
      </span>
    </button>
  </p>
  <p class="control">
    <button class="button transition fb-search-b" data-on="is-link is-light" data-active="false">
      <span id="cog" class="icon">
        <i class="fas fa-rocket"></i>
      </span>
    </button>
  </p>
    </div>
   </div>
   	<div style="margin-top: 10px;">
		{% for fb in feedback %}
			{% include 'comms/feedback/fb.html' %}
		{% endfor %}
	</div>
	{% if page_count > 0 %}
<nav class="pagination is-centered" role="navigation" aria-label="pagination">
  <a class="pagination-previous" {% if page == 1 %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':page-1}) }}"{% endif %}>Previous</a>
  <a class="pagination-next" {% if page == p_count %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':page+1}) }}"{% endif %}>Next page</a>
  <ul class="pagination-list">
    <li><a class="pagination-link" aria-label="Goto page 1"{% if page == 1 %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':1}) }}"{% endif %}>1</a></li>
    <li><span class="pagination-ellipsis"></span></li>
    <li><a class="pagination-link" aria-label="Goto page {{page-1}}" {% if page == 1 %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':page-1}) }}"{% endif %}>{{page-1}}</a></li>
    <li><a class="pagination-link is-current" aria-label="Page {{page}}" aria-current="page">{{page}}</a></li>
    <li><a class="pagination-link" aria-label="Goto page {{page+1}}"{% if page == page_count %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':page+1}) }}"{% endif %}>{{page+1}}</a></li>
    <li><span class="pagination-ellipsis"></span></li>
    <li><a class="pagination-link" aria-label="Goto page {{page_count}}" {% if page == page_count %}disabled{% else %}href="{{ funcs.edit_querystr(request.base_url,{'p':page_count}) }}"{% endif %}>{{page_count}}</a></li>
  </ul>
</nav>
{% else %}
<p class="subtitle is-1" id="no-results">No search results...</p>
{% endif %}
</div>

{% endblock %}
{% block scripts %}
<script type="text/javascript">
	$("#create-feedback").on('focus', function() {
		window.location.href = "/feedback/submit/";
	});

	$(".fb-search-b").on('click', function() {
		var $clicked = $(this);
		var clicked	= this;
		$(".fb-search-b").each(function() {
			var $this = $(this);
			if (this != clicked) {
			$this.attr('data-active', "false");
				$this.removeClass($this.data('on'));
			}
		})
		
		console.log($clicked.attr('data-active'));
		if ($clicked.attr('data-active') == "true") {
					$clicked.attr('data-active', "false");
					$clicked.removeClass($clicked.data('on'));
					console.log("DDED");

		}
		else {
			console.log("ADASASD");
		$clicked.attr('data-active', "true");
		$clicked.addClass($clicked.data('on'));
	}


	});

	$(".vote").on('click', function() {
		var $clicked = $(this);
		var $fb = $clicked.closest('.fb');
		var $counter = $fb.find('.counter').find('span');
		var $ballot = $fb.find('.ballot');
		var is_upvoted = $ballot.find('.upvote').attr('data-active') === "true";
		var is_downvoted = $ballot.find('.downvote').attr('data-active') === "true";
		var fb_id = $fb.data('id');
		var clicked	= this;


		function refreshBallot() {
		$ballot.find('.vote').each(function() {
			var $this = $(this);
			if (this != clicked) {
			$this.attr('data-active', "false");
				$this.removeClass($this.data('on'));
			}
		});
	}

	function upvote(fb_id) {
		post("/feedback/vote/", function (response) {
			var response = JSON.parse(response)["status"];
      refreshBallot();
			$clicked.attr('data-active', "true");
			$clicked.addClass($clicked.data('on'))
			if (is_downvoted) {
			$counter.text(parseInt($counter.text())+2);
			}
			else {
				$counter.text(parseInt($counter.text())+1);

			}
		},{'action':'upvote','fb_id':fb_id});
 	
	}

	function downvote(fb_id) {
		post("/feedback/vote/", function (response) {
			var response = JSON.parse(response)["status"];
      refreshBallot();
			$clicked.attr('data-active', "true");
			$clicked.addClass($clicked.data('on'));
			if (is_upvoted) {
			$counter.text(parseInt($counter.text())-2);
			}
			else {
				$counter.text(parseInt($counter.text())-1);
			}
		},{'action':'downvote','fb_id':fb_id});
	}

	function unupvote(fb_id) {
		post("/feedback/vote/", function (response) {
			var response = JSON.parse(response)["status"];
      refreshBallot();
			$clicked.attr('data-active', "false");
			$clicked.removeClass($clicked.data('on'));
			$counter.text(parseInt($counter.text())-1); 
		},{'action':'unupvote','fb_id':fb_id});
	}

	function undownvote(fb_id) {
		post("/feedback/vote/", function (response) {
			var response = JSON.parse(response)["status"];
      refreshBallot();
			$clicked.attr('data-active', "false");
			$clicked.removeClass($clicked.data('on'));
			$counter.text(parseInt($counter.text())+1); 
		},{'action':'undownvote','fb_id':fb_id});
	}

		if ($clicked.attr('data-active') === "true") {
			if ($clicked.hasClass('upvote')) {
				unupvote(fb_id);
			}
			else if ($clicked.hasClass('downvote')) {
				undownvote(fb_id);
			}
		}

		else {
			if ($clicked.hasClass('upvote')) {
				upvote(fb_id);
			}
			else if ($clicked.hasClass('downvote')) {
				downvote(fb_id);
			}
			
		}

		});





</script>
<style type="text/css">

	.pagination {
		margin-top: 10px;
		color: black;
	}

	.pagination-link, .pagination-previous, .pagination-next {
	background-color: white;
}

.pagination-ellipsis {

	color: black;
	font-size: 1.2em;
	font-weight: bold;
}

	.fb:not(:last-child) {
		margin-bottom: 10px;
	}

	.ballot-item:not(:last-child) {
		margin-bottom: 0px;
	}

/*
	.ballot-item span i {
		height: 18px;
	}
*/
	button.ballot-item {
		height: 20px;
		width: 	20px;
		padding-left: 10px;
		padding-right: 10px;
		border-width: 0px;

	}

	.ballot {
		width: 20px;
		display: inline-block;
		position: relative;
		margin-right: 10px;
		margin-left: 4px;
	}

	.fb {
		clear: both;
		padding: 7px;
		height: 80px;

	}

	.fb-content {
		vertical-align:top;
		margin-top: 10px;
				display: inline-block;

	}

</style>
{% endblock %}
